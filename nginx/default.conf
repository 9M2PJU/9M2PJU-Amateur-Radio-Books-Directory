# Define cache zone for directory listings
# Note: In Nginx, proxy_cache_path must be in the http block.
# Since this config is included in the http block via conf.d, it's valid to put it here if the main nginx.conf allows it.
# However, to be safe and efficient for DietPi, we'll also enable open_file_cache.

server {
    listen 80;
    server_name localhost;

    # Performance optimizations for DietPi
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Open File Cache - Reduces IO for static files (Great for SD cards)
    # Open File Cache - Reduces IO for static files (Great for SD cards)
    # open_file_cache max=1000 inactive=20s;
    # open_file_cache_valid 30s;
    # open_file_cache_min_uses 2;
    # open_file_cache_errors on;

    # Browser & Server Caching for Static Files
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # Cache static assets for 1 day
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|json|svg)$ {
            expires 1d;
            add_header Cache-Control "public, no-transform";
        }
    }

    # JSON Data Source for the UI
    location /api/list/ {
        alias /books/;
        autoindex on;
        autoindex_format json;
        index _none_;
        add_header Access-Control-Allow-Origin *;

        # Disable logging for these frequent requests to reduce I/O
        access_log off;

        # Add a cache-control header for the browser (60 seconds)
        # This prevents the browser from hammer the server on every click
        add_header Cache-Control "public, max-age=60";
    }

    # Stats Service Proxy
    location /api/stats/ {
        proxy_pass http://stats:3000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Direct File Access
    location /data/ {
        alias /books/;
        autoindex off;
        add_header Content-Disposition "inline";
        
        # Enable byte-range support for large PDFs
        # max_ranges 0; # Removed potentially problematic directive
        
        # Cache-control for books (they don't change often)
        expires 7d;
        add_header Cache-Control "public";
    }
}

